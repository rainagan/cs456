//package a2;

import java.nio.ByteBuffer;

public class Packet {
	/* 0 indicate data packet
	 * 1 indicate ACK packet
	 * 2 indicate EOT packet
	 */
	private static long type;
	// species total length of the packet in bytes, including 
	// the packet header. 
	// for ACK and EOT packets, the size of the packet is just
	// the size of the header
	private static long length;
	/* for data packets, the sequence number range is [0...255]
	 * for ACK packets, sequence number is the sequence number 
	 * of the packet being acknowledged
	 */
	private static long seqNumber;
	private static byte[] payload = new byte[500];
	
	Packet (int t, int l, int sn, byte[] p) throws Exception {
		if (p.length > 500) {
			throw new Exception("Exceed maximum payload length.");
		} else {
			type = unsignedInt(t);
			length = unsignedInt(l) % 256;
			seqNumber = unsignedInt(sn);
			payload = p;
		}
	}
	
	// function that cast int to unsigned int
	public long unsignedInt(int n) {
		return n&0xffffffffl;
	}
	
	public long getType() {
		return type;
	}
	public long getLength() {
		return length;
	}
	public long getSeqNum() {
		return seqNumber;
	}
	public byte[] getPayload() {
		return payload;
	}
	
	// create 3 types of packets
	public Packet dataPacket (int sn, byte[] p) throws Exception {
		return new Packet(0,12+p.length,sn,p);
	}
	public static Packet ACKPacket (int l, int sn) throws Exception {
		return new Packet(1,l,sn,new byte[0]);
	}
	public static Packet EOTPacket (int l, int sn) throws Exception {
		return new Packet(2,l,sn,new byte[0]);
	}
	
	// retrieve data from byte array
	public static Packet byteToPacket(byte[] b) throws Exception {
		ByteBuffer wrapped = ByteBuffer.wrap(b);
		int type = wrapped.getInt();
		int length = wrapped.getInt();
		int seqNumber = wrapped.getInt();
		// type, length and seqNumber are all 32-bit unsigned int, so in total 12 bytes
		byte[] payload = new byte[length-12];
		wrapped.get(payload, 0, length-12);
		Packet p = new Packet(type,length,seqNumber,payload);
		return p;
	}
	// put data into byte array
	public static byte[] PacketToByte(Packet p) throws Exception {
		// 12 byte of type, length, seqNumber and 500 byte of payload
		ByteBuffer buff = ByteBuffer.allocate(512);
		buff.putInt((int)type);
		buff.putInt((int)length);
		buff.putInt((int)seqNumber);
		buff.put(payload);
		return buff.array();
	}
}
